<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <base href="https://www.exemplo.com/calculadora-etiquetas/">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
  :root {
      --bg-color: #e0e5ec;
      --shadow-light: #ffffff;
      --shadow-dark: #a3b1c6;
      --primary: #6d5dfc;
      --success: #4CAF50;
      --danger: #ff6b6b;
      --greyLight: #bec8e4;
      --greyDark: #9baacf;
      --font-primary:  'Lucida Sans Unicode', 'Courier New', 'Franklin Gothic Medium', sans-serif;
    }
    
    body {
      font-family: var(--font-primary);
      background-color: var(--bg-color);
      margin: 0;
      padding: 20px;
      color: #444;
    }
    
    #loginForm {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: var(--bg-color);
    }

    #loginForm input {
      margin: 10px;
      padding: 12px;
      width: 250px;
      border: none;
      border-radius: 10px;
      background: var(--bg-color);
      box-shadow: 
        inset 2px 2px 5px var(--shadow-dark), 
        inset -2px -2px 5px var(--shadow-light);
      color: #333;
      font-size: 16px;
    }

    #loginForm button {
      margin: 20px;
      padding: 12px 25px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #loginForm button:hover {
      background-color: #5b4ceb;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 30px;
      cursor: text;
      opacity: 0.7;
      transition: opacity 0.3s;
    }
    
    h1:hover {
      opacity: 1;
    }
    
    .form-container {
      background: var(--bg-color);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 
        8px 8px 16px var(--shadow-dark), 
        -8px -8px 16px var(--shadow-light);
    }

    .toupu-container {
      margin-top: 20px;
      display: none;
    }
    
    .input-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      position: relative;
      width: 100%;
      transition: opacity 0.3s ease-in-out;
    }
    
    .normal-inputs, .toupu-inputs {
      opacity: 1;
    }

    .normal-inputs.hidden, .toupu-inputs.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .input-field {
      flex: 1;
      min-width: 200px;
    }
    
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: var(--bg-color);
      box-shadow: 
        inset 2px 2px 5px var(--shadow-dark), 
        inset -2px -2px 5px var(--shadow-light);
      color: #333;
      font-size: 16px;
    }
    
    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      outline: none;
      box-shadow: 
        inset 4px 4px 8px var(--shadow-dark), 
        inset -4px -4px 8px var(--shadow-light);
    }
    
    button {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
 color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 
        4px 4px 8px var(--shadow-dark), 
        -4px -4px 8px var(--shadow-light);
    }
    
    button:active {
      box-shadow: 
        inset 4px 4px 8px var(--shadow-dark), 
        inset -4px -4px 8px var(--shadow-light);
    }

    #calcular, #calcularToupu, #conectado {
  background: #28a745; /* Cor verde */
  border-radius: 12px; /* Bordas arredondadas */
  box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.2), 
              -5px -5px 15px rgba(255, 255, 255, 0.7); /* Efeito de sombra */
  color: white; /* Cor do texto */
  padding: 10px 20px; /* Padding para o botão */
  border: none; /* Sem borda */
  font-size: 16px; /* Tamanho da fonte */
  cursor: pointer; /* Cursor de ponteiro */
  transition: transform 0.3s, box-shadow 0.3s, background 0.3s; /* Transições suaves */
  min-width: 150px; /* Largura mínima */
  height: 40px; /* Altura fixa */
  position: relative; /* Para posicionamento do pseudo-elemento */
}

#calcular:hover, #calcularToupu:hover {
  box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2), 
              -3px -3px 10px rgba(255, 255, 255, 0.5); /* Efeito ao passar o mouse */
  background: #218838; /* Escurece o fundo ao passar o mouse */
}

#calcular:active, #calcularToupu:active {
  transform: translateY(4px); /* Aprofundar o botão quando clicado */
  box-shadow: inset 4px 4px 8px rgba(0, 0, 0, 0.3), 
              inset -4px -4px 8px rgba(255, 255, 255, 0.3); /* Efeito ao clicar */
}

/* Animação de brilho suave */
@keyframes anime {
  0% { background: #28a745; }
  50% { background: #3bbf76; }
  100% { background: #28a745; }
}

/* Mantém a animação em loop */
#calcular, #calcularToupu {
  animation: anime 5s linear infinite;
}



    #salvarPDF, #salvarXLSX {
      background-color: var(--primary);
    }
    
    #salvarPDF:hover, #salvarXLSX:hover {
      background-color: #5b4ceb;
    }

    #salvarEdicao {
      background-color: var(--primary);
    }
    
    #salvarEdicaoF:hover {
      background-color: #5b4ceb;
    }
    
    #acoes {
      background-color: var(--danger);
    }
    
    #acoes:hover {
      background-color: #ff5252;
    }

    #sairAcoes {
      background-color: #575151;
    }
    
    #sairAcoes:hover {
      background-color: #000000;
    }
    
    #resultado, #resultadoToupu {
      margin-left: 20px;
      font-weight: 600;
      color: var(--primary);
    }

    #apagarTodos {
      background-color: var(--danger);
    }
    
    #apagarTodos:hover {
      background-color: #ff5252;
    }

    #desconectar {
      background-color: var(--danger);
    }
    
    #desconectar:hover {
      background-color: #ff5252;
    }
    
    
    #confirmarApagar {
      background-color: #000000;
    }
    
    #confirmarApagar:hover {
        background-color: #575151;
    }

    #senhaAdmin {
      width: 100%; /* Preencher a largura disponível */
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: var(--bg-color); /* Cor de fundo */
      box-shadow: 
        inset 2px 2px 5px var(--shadow-dark), 
        inset -2px -2px 5px var(--shadow-light);
      color: #333; /* Cor do texto */
      font-size: 16px;
      margin-bottom: 15px; /* Espaço abaixo da caixa */
    }
    
    #senhaAdmin:focus {
      outline: none;
      box-shadow: 
        inset 4px 4px 8px var(--shadow-dark), 
        inset -4px -4px 8px var(--shadow-light);
    }
    
    #resultado {
      margin-left: 20px;
      font-weight: 600;
      color: var(--primary);
    }

    #confirmarExclusaoBtn {
      background-color: var(--danger);
    }
    
    #confirmarExclusaoBtn:hover {
      background-color: #ff5252;
    }
    
    #cancelarExclusaoBtn {
      background-color: #575151;
    }
    
    #cancelarExclusaoBtn:hover {
      background-color: #000000;
    }

    .switch-holder {
      display: flex;
      border-radius: 10px;
      background: var(--bg-color);
      box-shadow: 
        inset 2px 2px 5px var(--shadow-dark), 
        inset -2px -2px 5px var(--shadow-light);
      color: #333;
    }

    .switch-label {
      display: flex;
      margin-right: 10px;
      align-items: center;
    }

    .switch-toggle input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      z-index: -2;
    }

    .switch-toggle input[type="checkbox"] + label {
      position: relative;
      display: inline-block;
      width: 100px;
      height: 40px;
      border-radius: 20px;
      margin: 0;
      cursor: pointer;
      box-shadow: inset -8px -8px 15px rgba(255, 255, 255, .6),
            inset 10px 10px 10px rgba(0, 0, 0, .25);
    }

    .switch-toggle input[type="checkbox"] + label::before {
      position: absolute;
      content: 'OFF';
      font-size: 13px;
      text-align: center;
      line-height: 25px;
      top: 8px;
      left: 8px;
      width: 45px;
      height: 25px;
      border-radius: 20px;
      background-color: #eeeeee;
      box-shadow: -3px -3px 5px rgba(255, 255, 255, .5),
            3px 3px 5px rgba(0, 0, 0, .25);
      transition: .3s ease-in-out;
    }

    .switch-toggle input[type="checkbox"]:checked + label::before {
      left: 50%;
      content: 'ON';
      color: #fff;
      background-color: #5b4ceb;
      box-shadow: -3px -3px 5px rgba(255, 255, 255, .5),
            3px 3px 5px #ffffff;
    }

    .mode-toggles-container {
      margin-top: 20px;
    }

    .mode-toggles {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .register-buttons {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .action-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      background: var(--bg-color);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 
        8px 8px 16px var(--shadow-dark), 
        -8px -8px 16px var(--shadow-light);
    }
    
    th, td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid var(--greyLight);
    }
    
    th {
      background-color: var(--primary);
      color: white;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr:nth-child(even) {
      background-color: rgba(189, 195, 199, 0.1);
    }
    
    .used-all {
      background-color: var(--danger) !important;
      color: white;
    }
    
    .actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .search-bar {
      flex: 1;
      min-width: 200px;
      margin-right: 20px;
    }
    
    .search-bar input {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: var(--bg-color);
      box-shadow: 
        inset 2px 2px 5px var(--shadow-dark), 
        inset -2px -2px 5px var(--shadow-light);
      font-size: 16px;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    
    .pagination button {
      margin: 0 5px;
      padding: 8px 12px;
      background-color: var(--greyLight);
      color: var(--greyDark);
    }
    
    .pagination button.active {
      background-color: var(--danger);
      color: white;
    }

    .modal {
  display: none; /* Inicialmente escondido */
  position: fixed; /* Fixa o modal na tela */
  z-index: 1; /* Coloca o modal acima de outros elementos */
  left: 0;
  top: 0;
  width: 100%; /* Largura total */
  height: 100%; /* Altura total */
  overflow: auto; /* Permite rolagem se necessário */
  background-color: rgba(0, 0, 0, 0.4); /* Fundo escuro com transparência */
}


.modal-content {
  background-color: var(--bg-color); /* Fundo do modal usando a variável definida */
  margin: 15% auto; /* Centraliza o modal com margem superior */
  padding: 20px; /* Espaçamento interno */
  border-radius: 20px; /* Bordas arredondadas */
  box-shadow: 
    8px 8px 16px var(--shadow-dark), 
    -8px -8px 16px var(--shadow-light); /* Sombra do modal */
  width: auto; /* Remove a largura fixa */
  max-width: 500px; /* Largura máxima do modal */
  text-align: center; /* Centraliza o texto */
}

.modal-content p {
    padding: 0 0 10px 0; /* Adiciona um pouco de espaço abaixo do texto */
}

.modal-content button {
  margin: 5px; /* Adiciona um pouco de espaço entre os botões */
}

    .close {
      color: #000000;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover,
    .close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }

    .edit-btn, .delete-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2em;
      padding: 5px;
    }
    
    .edit-btn:hover, .delete-btn:hover {
      opacity: 0.7;
    }

    #calculosDetalhados {
      display: none;
      margin-top: 20px;
    }
    
    #calculosConteudo {
      margin: 0;
    }

    #calculosToupuDetalhados {
    display: none;
    }

    #calculosToupuConteudo {
     margin: 0;
    }

    #scrollToTopBtn {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--bg-color);
      border: none;
      box-shadow: 
        5px 5px 10px var(--shadow-dark), 
        -5px -5px 10px var(--shadow-light);
      color: var(--primary);
      font-size: 24px;
      cursor: pointer;
      outline: none;
      transition: all 0.3s ease;
      opacity: 0;
      visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

  #scrollToTopBtn:hover {
    background: linear-gradient(145deg, var(--shadow-light), var(--shadow-dark));
    color: var(--danger);
  }

  #scrollToTopBtn:active {
    box-shadow: 
      inset 5px 5px 10px var(--shadow-dark), 
      inset -5px -5px 10px var(--shadow-light);
  }

  #scrollToTopBtn.visible {
    opacity: 1;
    visibility: visible;
  }

  .autocomplete-list {
  list-style-type: none;
  padding: 0;
  margin: 0;
  position: absolute;
  border: 1px solid #ddd;
  background-color: white;
  z-index: 1;
}

.autocomplete-list li {
  padding: 10px;
  cursor: pointer;
}

.autocomplete-list li:hover {
  background-color: #f1f1f1;
}

.remove-word {
  float: right;
  color: #aaa;
  font-weight: bold;
  cursor: pointer;
}

.remove-word:hover {
  color: #000;
}

.reused-word {
  background-color: #e8ffe6;
}

  .counter {
    background-color: #5b4ceb;
    color: white;
    padding: 2px 5px;
    border-radius: 10px;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2), 
                -2px -2px 4px rgba(255, 255, 255, 0.5);
    font-size: 10px;
    text-align: center;
    transition: box-shadow 0.3s ease;
    display: inline-block;
  }

  .counter:hover {
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), 
                -2px -2px 4px rgba(255, 255, 255, 0.7);
    cursor: pointer;
  }

  .normal-inputs, .toupu-inputs {
    transition: display 0.3s ease;
  }
  
  .mode-toggles-container {
    margin-top: 20px;
  }

  .mode-toggles {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
  }

  .register-buttons {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .switch-holder {
    display: flex;
    align-items: center;
  }

  .switch-holder:last-of-type {
    margin-right: 20px;
  }

  slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color : var(--greyLight);
    transition: .4s;
    border-radius: 34px;
  }
  
  .slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: var(--primary);
  }
  
  input:checked + .slider:before {
    transform: translateX(26px);
  }

  #confirmarApagarTodosModal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
}

#confirmarApagarTodosModal .modal-content {
  background-color: var(--bg-color);
  margin: 15% auto;
  padding: 20px;
  border-radius: 20px;
  box-shadow: 
    8px 8px 16px var(--shadow-dark), 
    -8px -8px 16px var(--shadow-light);
  width: 80%;
  max-width: 500px;
}

#confirmarApagarTodosModal .close {
  color: #000000;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

#confirmarApagarTodosModal .close:hover,
#confirmarApagarTodosModal .close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}

#confirmarApagarTodosModal h2 {
  text-align: center;
  color: var(--primary);
  margin-bottom: 30px;
  cursor: text;
  opacity: 0.7;
  transition: opacity 0.3s;
}

#confirmarApagarTodosModal h2:hover {
  opacity: 1;
}

#confirmarApagarTodosModal p {
  margin-bottom: 20px;
}

#confirmarApagarTodosModal button {
  padding: 12px 25px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 
    4px 4px 8px var(--shadow-dark), 
    -4px -4px 8px var(--shadow-light);
}

#confirmarApagarTodosModal button:hover {
  box-shadow: 
    inset 4px 4px 8px var(--shadow-dark), 
    inset -4px -4px 8px var(--shadow-light);
}

#confirmarApagarTodosModal #confirmarApagarTodosBtn {
  background-color: var(--danger);
  color: white;
}

#confirmarApagarTodosModal #confirmarApagarTodosBtn:hover {
  background-color: #ff5252;
}

#confirmarApagarTodosModal #cancelarApagarTodosBtn {
  background-color: #575151;
  color: white;
}

#confirmarApagarTodosModal #cancelarApagarTodosBtn:hover {
  background-color: #000000;
}

#confirmarExclusaoToupuModal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
}

#confirmarExclusaoToupuModal .modal-content {
  background-color: var(--bg-color);
  margin: 15% auto;
  padding: 20px;
  border-radius: 20px;
  box-shadow: 
    8px 8px 16px var(--shadow-dark), 
    -8px -8px 16px var(--shadow-light);
  width: 80%;
  max-width: 500px;
}

#confirmarExclusaoToupuModal .close {
  color: #000000;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

#confirmarExclusaoToupuModal .close:hover,
#confirmarExclusaoToupuModal .close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}

#confirmarExclusaoToupuModal h2 {
  text-align: center;
  color: var(--primary);
  margin-bottom: 30px;
  cursor: text;
  opacity: 0.7;
  transition: opacity 0.3s;
}

#confirmarExclusaoToupuModal h2:hover {
  opacity: 1;
}

#confirmarExclusaoToupuModal p {
  margin-bottom: 20px;
}

#confirmarExclusaoToupuModal button {
  padding: 12px 25px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 
    4px 4px 8px var(--shadow-dark), 
    -4px -4px 8px var(--shadow-light);
}

#confirmarExclusaoToupuModal button:hover {
  box-shadow: 
    inset 4px 4px 8px var(--shadow-dark), 
    inset -4px -4px 8px var(--shadow-light);
}

#confirmarExclusaoToupuModal #confirmarExclusaoToupuBtn {
  background-color: var(--danger);
  color: white;
}

#confirmarExclusaoToupuModal #confirmarExclusaoToupuBtn:hover {
  background-color: #ff5252;
}

#confirmarExclusaoToupuModal #cancelarExclusaoToupuBtn {
  background-color: #575151;
  color: white;
}

#confirmarExclusaoToupuModal #cancelarExclusaoToupuBtn:hover {
  background-color: #000000;
}
  
</style>
</head>
<body>
   <!-- Tela de login -->
<div id="loginForm">
  <h2>Qualidade Uptec</h2>
  <input type="text" id="loginUsername" placeholder="Username" required >
  <input type="password" id="loginPassword" placeholder="Password" required autocomplete="off">
  <button onclick="login()">Login</button>
  <p id="loginError" style="color: red;"></p> <!-- Para exibir mensagens de erro -->
  </div>
<!-- Fim da tela de login -->
<div class="container" id="appContainer" style="display:none;">
  <!-- Conteúdo da aplicação -->

  <h1 contenteditable="true">Registro de Etiquetas</h1>
<!-- INICIO: Controle de pessoas online -->
<div class="counter-container" id="counter" style="position: fixed; top: 0; left: 50%; transform: translateX(-50%); z-index: 9999;">
  <span class="counter" onclick="showLogoutModal()">
    <span id="connectedUsersCount">0</span> ONLINE
  </span>
</div>

<!-- Modal confirmar saida-->
<div id="logoutModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeLogoutModal()">&times;</span>
    <h2 style="margin: 0;">Atenção!</h2>
    <p>Ao continuar você será desconectado. Para acessar novamente, insira seu e-mail e senha.</p>
    <p>Você deseja realmente sair?</p>  
    <div style="margin-top: 20px;">
      <button id="desconectar" onclick="logout()">Desconectar</button>
      <button id="conectado" onclick="closeLogoutModal()">Continuar Conectado</button>
    </div>
  </div>
</div>
<script>
  let lastScrollTop = 0;
  const counter = document.getElementById('counter');

  window.addEventListener('scroll', function() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

    if (scrollTop > lastScrollTop) {
      // Scroll para baixo
      counter.style.display = 'none';
    } else if (scrollTop === 0) {
      // Scroll no topo
      counter.style.display = 'block';
    }

    lastScrollTop = scrollTop <= 0 ? 0 : scrollTop; // Para evitar números negativos
  });
</script>
<!-- END: Controle de pessoas online -->

 
  <!-- Container da página -->
  <div class="form-container">
    <!-- Grupo de inputs para registros normais -->
      <div class="input-group normal-inputs">
        <div class="input-field">
          <input type="text" id="codigoPeca" list="codigoPecaList" placeholder="Código da Peça" autocomplete="on">
          <datalist id="codigoPecaList"></datalist>
        </div>
        <div class="input-field">
          <input type="text" id="numeroLote" list="numeroLoteList" placeholder="Número do Lote" autocomplete="on">
          <datalist id="numeroLoteList"></datalist>
        </div>
        <div class="input-field">
          <input type="number" id="totalPecas" placeholder="Total de Peças" required autocomplete="on">
        </div>
        <div class="input-field">
          <input type="number" id="pecasPorCaixa" placeholder="Peças por Caixa" required autocomplete="on">
        </div>
        <div class="input-field">
          <input type="text" id="observacoes" list="observacoesList" placeholder="Observações" autocomplete="on">
          <datalist id="observacoesList"></datalist>
        </div>
      </div>

    <!-- Grupo de inputs para registros Toupu -->
    <div class="input-group toupu-inputs" style="display: none;">
      <div class="input-field">
        <select id="codigoPecaToupu">
          <option value="">Selecione o código Toupu</option>
          <option value="2095270004-1">2095270004-1</option>
          <option value="2095270003-1">2095270003-1</option>
          <option value="20028524-1">20028524-1</option>
          <option value="10018462-1">10018462-1</option>
          <option value="2095490002-1">2095490002-1</option>
          <option value="2095080003-1">2095080003-1</option>
          <option value="2095160004-1">2095160004-1</option>
          <option value="10018996-1">10018996-1</option>
          <option value="2095430002-1">2095430002-1</option>
          <option value="2095080004-1">2095080004-1</option>
          <option value="2095160007-1">2095160007-1</option>
        </select>
      </div>
      <div class="input-field">
 <input type="text" id="numeroLoteToupu" list="numeroLoteList" placeholder="Número do Lote" autocomplete="on">
        <datalist id="numeroLoteList"></datalist>
      </div>
      <div class="input-field">
        <input type="number" id="totalPecasToupu" placeholder="Total de Peças" required autocomplete="on">
      </div>
      <div class="input-field">
        <input type="text" id="observacoesToupu" list="observacoesList" placeholder="Observações" autocomplete="on">
        <datalist id="observacoesList"></datalist>
      </div>
    </div>

    <!-- Cálculos detalhados -->
    <div id="calculosDetalhados" style="display: none;">
      <p id="calculosConteudo"></p>
    </div>

    <div id="calculosToupuDetalhados" style="display: none;">
      <p id="calculosToupuConteudo"></p>
    </div>

    <!-- Botões de registro -->
    <div class="mode-toggles-container">
      <div class="mode-toggles">
        <div class="switch-holder">
          <div class="switch-label">
            <i class="fa fa-bluetooth-b"></i><span>Modo Toupu</span>
          </div>
          <div class="switch-toggle">
            <input type="checkbox" id="toggleToupu">
            <label for="toggleToupu"></label>
          </div>
        </div>

        <div class="switch-holder">
          <div class="switch-label">
            <i class="fa fa-bluetooth-b"></i><span>Mostrar Cálculos</span>
          </div>
          <div class="switch-toggle">
            <input type="checkbox" id="mostrarCalculos">
            <label for="mostrarCalculos"></label>
          </div>
        </div>

        <div class="register-buttons">
          <button id="calcular">Registrar</button>
          <button id="calcularToupu" style="display: none;">Registrar</button>
                    <!-- Resultados -->
          <span id="resultado" style="display: none;"></span>
          <span id="resultadoToupu" style="display: none;"></span>
        </div>
      </div>
    </div>

    <!-- Barra de busca -->
    <div class="actions">
      <div class="search-bar normal-search">
        <input type="text" id="searchInput" placeholder="Buscar registros normais...">
      </div>
      <div class="search-bar toupu-search" style="display: none;">
        <input type="text" id="searchInputToupu" placeholder="Buscar registros Toupu...">
      </div>

      <!-- Botões de ação -->
      <button id="salvarPDF">Salvar PDF</button>
      <button id="salvarXLSX">Salvar XLSX</button>
      <button id="acoes">Ações</button>
    </div>

    <!-- Paginação -->
    <div class="pagination" id="pagination"></div>
    <div class="pagination" id="paginationToupu" style="display: none;"></div>

    <!-- Tabela de registros -->
    <table id="registrosTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Data do Registro</th>
          <th>Código da Peça</th>
          <th>Número do Lote</th>
          <th>Total de Peças</th>
          <th>Peças por Caixa</th>
          <th>Peças Extras</th>
          <th>Etiquetas Necessárias</th>
          <th>Etiquetas Usadas</th>
          <th>Observação</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Tabela de registros Toupu -->
    <table id="registrosToupuTable" style="display: none;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Data do Registro</th>
          <th>Código da Peça</th>
          <th>Número do Lote</th>
          <th>Peças por Saco</th>
          <th>Sacos por Palete</th>
          <th>Total de Paletes</th>
          <th>Etiquetas Necessárias</th>
          <th>Etiquetas Usadas</th>
          <th>Observação</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modais -->
  <div id="calculosModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Cálculos Detalhados</h2>
      <div id="calculosDetalhados"></div>
    </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Editar Registro</h2>
      <input type="hidden" id="editIndex">
      <label for="editCodigoPeca">Código da Peça:</label>
      <input type="text" id="editCodigoPeca" placeholder="Código da Peça">
      <label for="editNumeroLote">Número do Lote:</label>
      <input type="text" id="editNumeroLote" placeholder="Número do Lote">
      <label for="editEtiquetasNecessarias">Etiquetas Necessárias:</label>
      <input type="number" id="editEtiquetasNecessarias" placeholder="Etiquetas Necessárias" required min="0">
      <label for="editPecasExtras">Peças Extras:</label>
      <input type="number" id="editPecasExtras" placeholder="Peças Extras" required min="0">
      <label for="editObservacoes">Observações:</label>
      <input type="text" id="editObservacoes" placeholder="Observações">
      <p id="editTotalPecas">Total de Peças: 0</p>
      <p id="editEtiquetasNecessariasCalc"></p>
      <button id="salvarEdicao">Salvar</button>
    </div>
  </div>

  <div id="acoesModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Ações</h2>
      <button id="apagarTodos">Apagar todos os registros</button>
      <button id="sairAcoes">Sair</button>
    </div>
  </div>

  <div id="confirmarApagarTodosModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Confirmar exclusão</h2>
      <p>Tem certeza que deseja apagar todos os registros? Essa ação é irreversível e pode causar perda de dados importantes. Salve os registros antes de prosseguir.</p>
      <button id="confirmarApagarTodosBtn">Confirmar</button>
      <button id="cancelarApagarTodosBtn">Cancelar</button>
    </div>
  </div>

  <div id="confirmarApagarModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Confirmar exclusão</h2>
      <p>Tem certeza que deseja excluir todos os registros? Esta ação não pode ser desfeita.</p>
      <input type="password" id="senhaAdmin" placeholder="Senha de administrador" autocomplete="off">
      <button id="confirmarApagar">Confirmar</button>
    </div>
  </div>

  <div id="confirmarExclusaoModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Confirmar exclusão</h2>
      <p>Tem certeza que deseja excluir este registro?</p>
      <button id="confirmarExclusaoBtn">Apagar Registro</button>
      <button id="cancelarExclusaoBtn">Sair</button>
    </div>
  </div>

  <div id="confirmarExclusaoToupuModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Confirmar exclusão</h2>
      <p>Tem certeza que deseja excluir este registro?</p>
      <button id="confirmarExclusaoToupuBtn">Apagar Registro</button>
      <button id="cancelarExclusaoToupuBtn">Sair</button>
    </div>
  </div>

  <!-- Botão de scroll para o topo -->
  <button id="scrollToTopBtn" title="SUBIR"><i class="fas fa-arrow-alt-circle-up"></i></button>

  <!-- bibliotecas JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>

  // 1. Firebase Configuração e inicialização
  

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDcO7xRFNA00cE8rAddqYk0sBQuTf9YEWs",
  authDomain: "osucessotriunfal.firebaseapp.com",
  databaseURL: "https://osucessotriunfal-default-rtdb.firebaseio.com",
  projectId: "osucessotriunfal",
  storageBucket: "osucessotriunfal.firebasestorage.app",
  messagingSenderId: "954572226460",
  appId: "1:954572226460:web:12f970646aeadc1f08d259",
  measurementId: "G-WGMQR3SFM5"
};

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  carregarRegistrosFirebase();
  carregarRegistrosToupuFirebase();
  const auth = firebase.auth();

  // 2. Variaveis Globais e constantes
  let registros = [];
  let nextId = 1;
  let paginaAtual = 1;
  const itensPorPagina = 100;
  let paginaAtualToupu = 1;
  const itensPorPaginaToupu = 100;
  let registroParaExcluir = null;
  let wordCache = {};
  const inputFields = ['codigoPeca', 'numeroLote', 'observacoes'];
  let registrosToupu = [];
  let nextIdToupu = 1;
  let registroParaExcluirToupu = null;
  let isTyping = false; // Variável para controlar se o usuário está digitando
  
  const toupuCodes = {
  "2095270004-1": { pecasPorSaco: 100, sacosPorPalete: 43.2, totalPorPalete: 4320 },
  "2095270003-1": { pecasPorSaco: 25, sacosPorPalete: 77.76, totalPorPalete: 1944 },
  "20028524-1": { pecasPorSaco: 25, sacosPorPalete: 64.8, totalPorPalete: 1620 },
  "10018462-1": { pecasPorSaco: 200, sacosPorPalete: 30, totalPorPalete: 6000 },
  "2095490002-1": { pecasPorSaco: 300, sacosPorPalete: 54, totalPorPalete: 16200 },
  "2095080003-1": { pecasPorSaco: 100, sacosPorPalete: 50.4, totalPorPalete: 5040 },
  "2095160004-1": { pecasPorSaco: 20, sacosPorPalete: 108, totalPorPalete: 2160 },
  "10018996-1": { pecasPorSaco: 50, sacosPorPalete: 66, totalPorPalete: 3300 },
  "2095430002-1": { pecasPorSaco: 50, sacosPorPalete: 60, totalPorPalete: 3000 },
  "2095080004-1": { pecasPorSaco: 50, sacosPorPalete: 54, totalPorPalete: 2700 },
  "2095160007-1": { pecasPorSaco: 50, sacosPorPalete: 43.2, totalPorPalete: 2160 }
};

  // 3. Funçoes utilitarias

//COMEÇO LOGIN
// Função para fazer login
function login() {
  const email = document.getElementById('loginUsername').value; // Use o campo de username como email
  const password = document.getElementById('loginPassword').value;

  firebase.auth().signInWithEmailAndPassword(email, password)
    .then((userCredential) => {
      // Login bem-sucedido
      const user = userCredential.user;
      console.log("Login bem-sucedido:", user);
      document.getElementById('loginForm').style.display = 'none'; // Esconde o formulário de login
      document.getElementById('appContainer').style.display = 'block'; // Mostra a aplicação
    })
    .catch((error) => {
      const errorCode = error.code;
      const errorMessage = error.message;

      // Personaliza a mensagem de erro
      switch (errorCode) {
        case 'auth/user-not-found':
          document.getElementById('loginError').textContent = "Usuário não encontrado. Por favor, verifique seu e-mail.";
          break;
        case 'auth/wrong-password':
          document.getElementById('loginError').textContent = "Senha incorreta. Tente novamente.";
          break;
        case 'auth/invalid-email':
          document.getElementById('loginError').textContent = "E-mail inválido. Verifique o formato.";
          break;
        default:
          document.getElementById('loginError').textContent = "Erro ao fazer login: " + errorMessage;
      }

      console.error("Erro ao fazer login:", errorMessage);
    });
}

// Função para fazer logout
function logout() {
  firebase.auth().signOut().then(() => {
    console.log("Logout bem-sucedido");
    document.getElementById('loginForm').style.display = 'flex'; // Mostra o formulário de login
    document.getElementById('appContainer').style.display = 'none'; // Esconde a aplicação
  }).catch((error) => {
    console.error("Erro ao fazer logout:", error);
  });
}

// Escuta o estado de autenticação
firebase.auth().onAuthStateChanged((user) => {
  if (user) {
    // Usuário está logado
    console.log("Usuário logado:", user);
    document.getElementById('loginForm').style.display = 'none'; // Esconde o formulário de login
    document.getElementById('appContainer').style.display = 'block'; // Mostra a aplicação
  } else {
    // Usuário não está logado
    console.log("Usuário não logado");
    document.getElementById('loginForm').style.display = 'flex'; // Mostra o formulário de login
    document.getElementById('appContainer').style.display = 'none'; // Esconde a aplicação
  }
});
//FINAL LOGIN

// Sair da pagina

function showLogoutModal() {
  const modal = document.getElementById('logoutModal');
  modal.style.display = 'flex'; // Exibe o modal
}

function closeLogoutModal() {
  const modal = document.getElementById('logoutModal');
  modal.style.display = 'none'; // Esconde o modal
}

// Adiciona um evento de clique fora do modal para fechá-lo
window.onclick = function(event) {
  const modals = document.querySelectorAll('.modal'); // Seleciona todos os modais
  modals.forEach(modal => {
    if (event.target === modal) {
      modal.style.display = 'none'; // Esconde o modal
    }
  });
}

// Função para carregar as palavras da coleção 'words'
function loadWordsFromFirebase() {
  inputFields.forEach(field => {
    db.collection('words').doc(field).get().then(doc => {
      if (doc.exists) {
        wordCache[field] = doc.data().words;
        updateAutocompleteList(document.getElementById(field), wordCache[field]);
      } else {
        wordCache[field] = [];
      }
    });
  });
}


// Função para carregar sugestões do localStorage
function loadSuggestionsFromLocalStorage() {
    const suggestions = JSON.parse(localStorage.getItem('suggestions')) || [];
    suggestions.forEach(suggestion => {
        addSuggestionToDatalist(suggestion);
    });
}

// Função para adicionar uma sugestão ao datalist
function addSuggestionToDatalist(suggestion) {
    const datalist = document.getElementById('codigoPecaList'); // ou outro datalist conforme necessário
    const option = document.createElement('option');
    option.value = suggestion;
    datalist.appendChild(option);
}

// Função para atualizar o localStorage com palavras
function updateLocalStorageWithWords() {
    const uniqueWords = new Set();

    // Coletar palavras de todos os registros
    registros.forEach(registro => {
        if (registro.codigoPeca) uniqueWords.add(registro.codigoPeca);
        if (registro.numeroLote) uniqueWords.add(registro.numeroLote);
        if (registro.observacoes) uniqueWords.add(registro.observacoes);
    });

    // Armazenar no localStorage
    localStorage.setItem('suggestions', JSON.stringify(Array.from(uniqueWords)));
}

// Chama a função para carregar as palavras ao iniciar
document.addEventListener('DOMContentLoaded', loadWordsFromFirebase);

function saveWord(field, word) {
    if (!wordCache[field].includes(word)) {
        wordCache[field].push(word);
        db.collection('words').doc(field).set({
            words: firebase.firestore.FieldValue.arrayUnion(word)
        }, { merge: true });
    }
}

function removeWord(field, word) {
    const index = wordCache[field].indexOf(word);
    if (index > -1) {
        wordCache[field].splice(index, 1);
        db.collection('words').doc(field).update({
            words: firebase.firestore.FieldValue.arrayRemove(word)
        });
    }
}

  function getAutocompleteSuggestions(field, prefix) {
    return wordCache[field].filter(word => word.toLowerCase().startsWith(prefix.toLowerCase()));
  }
  function updateAutocompleteList(input, suggestions) {
    let list = input.nextElementSibling;
    if (!list || !list.classList.contains('autocomplete-list')) {
      list = document.createElement('ul');
      list.className = 'autocomplete-list';
      input.parentNode.insertBefore(list, input.nextSibling);
    }
    list.innerHTML = '';
    suggestions.forEach(word => {
      const item = document.createElement('li');
      item.textContent = word;
      item.addEventListener('click', () => {
        input.value = word;
        list.innerHTML = '';
      });
      const removeBtn = document.createElement('span');
      removeBtn.textContent = '✕';
      removeBtn.className = 'remove-word';
      removeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        removeWord(input.id, word);
        list.removeChild(item);
      });
      item.appendChild(removeBtn);
      list.appendChild(item);
    });
  }
  function highlightReusedWord(input) {
    if (wordCache[input.id].includes(input.value)) {
      input.classList.add('reused-word');
    } else {
      input.classList.remove('reused-word');
    }
  }

  function saveSuggestionToFirebase(codigoPeca, numeroLote) {
    // Salva o código da peça
    db.collection('suggestions').doc(codigoPeca).set({
        codigo: codigoPeca
    }, { merge: true });
    
    // Salva o número do lote
    db.collection('suggestions').doc(numeroLote).set({
        lote: numeroLote
    }, { merge: true });
}

function loadSuggestionsFromFirebase() {
    db.collection('suggestions').get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
            const suggestion = doc.id; // O ID do documento é o código ou lote
            addSuggestionToDatalist(suggestion); // Adiciona a sugestão ao datalist
        });
    }).catch((error) => {
        console.error("Erro ao carregar sugestões: ", error);
    });
}

 // 4. Funcoes gerenciamento de dados
// Função para salvar registro no Firebase
function salvarRegistroFirebase(registro) {
    db.collection("registros").doc(String(registro.id)).set(registro)
    .then(() => {
        console.log("Registro salvo com sucesso: ", registro.id);
    })
    .catch((error) => {
        console.error("Erro ao salvar registro: ", error);
    });
}

  function salvarRegistroToupuFirebase(registro) {
  const registroId = registro.id || `T${nextIdToupu}`; 
  
  db.collection("registrosToupu").doc(registroId).set(registro)
    .then(() => {
      console.log("Registro Toupu salvo com sucesso:", registroId);
    })
    .catch((error) => {
      console.error("Erro ao salvar registro Toupu:", error);
    });
}


  function atualizarRegistroFirebase(registro) {
    db.collection("registros").where("id", "==", registro.id).get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          doc.ref.update(registro);
        });
      });
  }
  function excluirRegistroFirebase(id) {
    db.collection("registros").where("id", "==", id).get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          doc.ref.delete();
        });
      });
  }


  
  // Função para ouvir as alterações nos dados e atualizar a tabela em tempo real
  function carregarRegistrosFirebase() {
  db.collection("registros").orderBy("id", "desc").onSnapshot((querySnapshot) => {
    registros = []; // Limpa os registros antes de carregar os novos
    querySnapshot.forEach((doc) => {
      const registro = doc.data();
      registros.push(registro); // Adiciona o registro à lista
    });

    if (registros.length > 0) {
      nextId = Math.max(...registros.map(r => r.id)) + 1; // Atualiza o próximo ID para registros
    } else {
      nextId = 1;
    }

    atualizarTabela(); // Atualiza a tabela com os registros carregados
  }, (error) => {
    console.error("Erro ao carregar registros: ", error);
  });
}

 
function carregarRegistrosToupuFirebase() {
    db.collection("registrosToupu").orderBy("id", "desc").onSnapshot((querySnapshot) => {
        registrosToupu = []; // Limpa os registros antes de carregar novos
        querySnapshot.forEach((doc) => {
            let registro = doc.data();
            registro.id = doc.id; // Assegura que o ID do Firebase é mantido
            registrosToupu.push(registro); // Adiciona o registro à lista
        });

        // Determina o próximo ID
        if (registrosToupu.length > 0) {
            nextIdToupu = Math.max(...registrosToupu.map(r => parseInt(r.id.replace('T', ''), 10))) + 1;
        } else {
            nextIdToupu = 1;
        }

        atualizarTabelaToupu(); // Atualiza a tabela com os registros carregados
    }, (error) => {
        console.error("Erro ao carregar registros Toupu: ", error);
    });
}



// Função para carregar as quantidades de peças do Firebase
function carregarQuantidadesPecas() {
  db.collection('pecasPorCaixa').get().then(querySnapshot => {
    querySnapshot.forEach(doc => {
      const codigoPeca = doc.id;
      const quantidadePecas = doc.data().quantidadePecas;
      // Preenche o campo de quantidade de peças com a quantidade armazenada no Firebase
      document.getElementById('pecasPorCaixa').value = quantidadePecas;
    });
  });
}

// Chama a função para carregar as quantidades de peças do Firebase quando a página é carregada
document.addEventListener('DOMContentLoaded', carregarQuantidadesPecas);
// Função para armazenar a quantidade de peças
function armazenarQuantidadePecas(codigoPeca, quantidadePecas) {
  db.collection('pecasPorCaixa').doc(codigoPeca).set({
    quantidadePecas: quantidadePecas
  });
}

// Função para preencher automaticamente o campo de quantidade de peças
function preencherQuantidadePecas(codigoPeca) {
  db.collection('pecasPorCaixa').doc(codigoPeca).get().then(doc => {
    if (doc.exists) {
      const quantidadePecas = doc.data().quantidadePecas;
      document.getElementById('pecasPorCaixa').value = quantidadePecas;
    }
  });
}

// Adiciona um evento de input ao campo de código de peça
const codigoPecaInput = document.getElementById('codigoPeca');
codigoPecaInput.addEventListener('input', (e) => {
  const codigoPeca = e.target.value;
  preencherQuantidadePecas(codigoPeca);
});

// Adiciona um evento de click ao botão de registrar
const registrarButton = document.getElementById('calcular');
registrarButton.addEventListener('click', () => {
  const codigoPeca = document.getElementById('codigoPeca').value;
  const quantidadePecas = document.getElementById('pecasPorCaixa').value;
  armazenarQuantidadePecas(codigoPeca, quantidadePecas);
});

// Função para verificar se o lote existe modo normal
function verificarLote(lote) {
  if (lote === '') {
    return;
  }
  const registros = db.collection('registros').where('numeroLote', '==', lote);
  registros.get().then((querySnapshot) => {
    if (querySnapshot.docs.length > 0) {
      console.log('Lote repetido!');
      // Exibe um alerta para o usuário
      
      // Muda a cor da caixa de entrada de lote para vermelho
      document.getElementById('numeroLote').style.border = '2px solid red';
    } else {
      console.log('Lote não existe!');
      // Muda a cor da caixa de entrada de lote para verde
      document.getElementById('numeroLote').style.border = '2px solid blue';
    }
  }).catch((error) => {
    console.error("Erro ao verificar lote: ", error);
    alert("Erro ao verificar lote: " + error.message);
  });
}

// Função para verificar se o lote existe modo toupu
function verificarLoteToupu(lote) {
    if (lote === '') {
        return;
    }
    const registrosToupuRef = db.collection('registrosToupu').where('numeroLote', '==', lote);
    registrosToupuRef.get().then((querySnapshot) => {
        if (querySnapshot.docs.length > 0) {
            console.log('Lote repetido no modo Toupu!');
            // Muda a cor da caixa de entrada de lote para vermelho
            document.getElementById('numeroLoteToupu').style.border = '2px solid red';
        } else {
            console.log('Lote não existe no modo Toupu!');
            // Muda a cor da caixa de entrada de lote para verde
            document.getElementById('numeroLoteToupu').style.border = '2px solid blue';
        }
    }).catch((error) => {
        console.error("Erro ao verificar lote no modo Toupu: ", error);
        alert("Erro ao verificar lote: " + error.message);
    });
}

  function salvarLocalStorage() {
    localStorage.setItem('registrosEtiquetas', JSON.stringify(registros));
  }
  function carregarLocalStorage() {
    const savedRegistros = localStorage.getItem('registrosEtiquetas');
    if (savedRegistros) {
      registros = JSON.parse(savedRegistros);
      nextId = Math.max(...registros.map(r => r.id)) + 1;
    }
  }
  function salvarLocalStorageToupu() {
    localStorage.setItem('registrosToupu', JSON.stringify(registrosToupu));
  }
  function carregarLocalStorageToupu() {
    const savedRegistros = localStorage.getItem('registrosToupu');
    if (savedRegistros) {
      registrosToupu = JSON.parse(savedRegistros);
      nextIdToupu = Math.max(...registrosToupu.map(r => r.id)) + 1;
    }
  }

  function atualizarRegistroToupuFirebase(registro) {
    // Validação do ID
    if (!registro.id.startsWith('T')) {
        alert("ID de registro inválido.");
        return;
    }

    // Atualização do registro
    db.collection("registrosToupu").doc(registro.id).update({
        etiquetasUsadas: registro.etiquetasUsadas,
        // Aqui você pode adicionar outros campos do registro se necessário
    })
    .then(() => {
        console.log("Registro Toupu atualizado com sucesso:", registro.id);
    })
    .catch((error) => {
        console.error("Erro ao atualizar registro Toupu:", error);
    });
}


  function excluirRegistroToupuFirebase(id) {
    db.collection("registrosToupu").where("id", "==", id).get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          doc.ref.delete();
        });
      });
  }

  // 5. funçoes de updates
  function atualizarTabela() {
    if (isTyping) return; // Não atualiza se o usuário estiver digitando
    const tbody = document.querySelector('#registrosTable tbody');
    tbody.innerHTML = '';

    const inicio = (paginaAtual - 1) * itensPorPagina;
    const fim = inicio + itensPorPagina;
    const registrosPagina = registros.slice(inicio, fim);

    registrosPagina.forEach((registro, index) => {
      const tr = document.createElement('tr');
      if (registro.etiquetasUsadas === registro.etiquetasNecessarias) {
        tr.classList.add('used-all');
      }
      const etiquetasCompletas = registro.etiquetasNecessarias - (registro.pecasExtras > 0 ? 1 : 0);
      tr.innerHTML = `
        <td>${registro.id}</td>
        <td>${registro.data}</td>
        <td>${registro.codigoPeca}</td>
        <td>${registro.numeroLote}</td>
        <td>${registro.totalPecas}</td>
        <td>${registro.pecasPorCaixa}</td>
        <td>${registro.pecasExtras}</td>
        <td>${registro.etiquetasNecessarias}${registro.pecasExtras > 0 ? ` (${etiquetasCompletas} completas + 1 extra (${registro.pecasExtras} peças)` : ''}</td>
        <td contenteditable="true" oninput="atualizarEtiquetasUsadas(${index + inicio}, this)">${registro.etiquetasUsadas}</td>
        <td>${registro.observacoes}</td>
        <td>
          <button class="edit-btn" onclick="editarRegistro(${registro.id})">✏️</button>
         <button class="delete-btn" onclick="confirmarExclusaoRegistro(${registro.id})">🗑️</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    adicionarEventosFoco();
    atualizarPaginacao();
  }
  function atualizarTabelaToupu() {
    if (isTyping) return; // Não atualiza se o usuário estiver digitando

  const tbody = document.querySelector('#registrosToupuTable tbody');
  tbody.innerHTML = '';

  // Ordena os registros por ID de forma decrescente (mais recentes no topo)
  const registrosOrdenados = [...registrosToupu].sort((a, b) => parseInt(b.id.replace('T', '')) - parseInt(a.id.replace('T', '')));

  const inicio = (paginaAtualToupu - 1) * itensPorPaginaToupu;
  const fim = inicio + itensPorPaginaToupu;
  const registrosPagina = registrosOrdenados.slice(inicio, fim); // Exibe os registros da página atual

  registrosPagina.forEach((registro, index) => {
    const tr = document.createElement('tr');
    if (registro.etiquetasUsadas === registro.etiquetasNecessarias) {
      tr.classList.add('used-all');
    }
    const etiquetasInfo = registro.pecasExtras > 0 
      ? `${registro.etiquetasCompletas} + 1 extra (${registro.pecasExtras} peças)`
      : `${registro.etiquetasNecessarias}`;
    tr.innerHTML = `
      <td>${registro.id}</td>
      <td>${registro.data}</td>
      <td>${registro.codigoPeca}</td>
      <td>${registro.numeroLote}</td>
      <td>${registro.pecasPorSaco}</td>
      <td>${registro.sacosPorPalete}</td>
      <td>${registro.totalPaletes}</td>
      <td>${etiquetasInfo}</td>
      <td contenteditable="true" oninput="atualizarEtiquetasUsadasToupu(${index}, this)">${registro.etiquetasUsadas}</td>
      <td>${registro.observacoes}</td>
      <td>
  <button class="delete-btn" onclick="confirmarExclusaoRegistroToupu('${registro.id}')">🗑️</button>
</td>
    `;
    tbody.appendChild(tr);
  });

  adicionarEventosFoco();
  atualizarPaginacaoToupu();
  
}

//  função para manter o foco na caixa de entrada da coluna Etiquetas Usadas ao ser clicado
  // Função para adicionar eventos de foco e digitação
function adicionarEventosFoco() {
    const etiquetasUsadasCells = document.querySelectorAll('#registrosTable tbody td[contenteditable="true"]');
    const etiquetasUsadasToupuCells = document.querySelectorAll('#registrosToupuTable tbody td[contenteditable="true"]');

    etiquetasUsadasCells.forEach(cell => {
        cell.addEventListener('focus', () => {
            isTyping = true; // O usuário começou a digitar
        });

        cell.addEventListener('blur', () => {
            isTyping = false; // O usuário parou de digitar
            // Atualiza a tabela após um pequeno atraso
            setTimeout(() => {
                atualizarTabela();
            }, 100); // Atraso de 100 ms
        });

        cell.addEventListener('input', () => {
            // Atualiza o valor no registro
            const index = Array.from(cell.closest('tbody').children).indexOf(cell.closest('tr'));
            atualizarEtiquetasUsadas(index, cell);
        });
    });

    etiquetasUsadasToupuCells.forEach(cell => {
        cell.addEventListener('focus', () => {
            isTyping = true; // O usuário começou a digitar
        });

        cell.addEventListener('blur', () => {
            isTyping = false; // O usuário parou de digitar
            // Atualiza a tabela após um pequeno atraso
            setTimeout(() => {
                atualizarTabelaToupu();
            }, 100); // Atraso de 100 ms
        });

        cell.addEventListener('input', () => {
            // Atualiza o valor no registro
            const index = Array.from(cell.closest('tbody').children).indexOf(cell.closest('tr'));
            atualizarEtiquetasUsadasToupu(index, cell);
        });
    });
}

  function atualizarPaginacao() {
    const totalPaginas = Math.ceil(registros.length / itensPorPagina);
    const paginationContainer = document.getElementById('pagination');
    paginationContainer.innerHTML = '';

    // Add "Anterior" button
    const anteriorButton = document.createElement('button');
    anteriorButton.textContent = 'Anterior';
anteriorButton.addEventListener('click', () => {
      if (paginaAtual > 1) {
        paginaAtual--;
        atualizarTabela();
      }
    });
    paginationContainer.appendChild(anteriorButton);

    // Calculate range of pages to show
    let startPage = Math.max(1, paginaAtual - 2);
    let endPage = Math.min(totalPaginas, startPage + 4);
    
    if (endPage - startPage < 4) {
      startPage = Math.max(1, endPage - 4);
    }

    // Add page buttons
    for (let i = startPage; i <= endPage; i++) {
      const button = document.createElement('button');
      button.textContent = i;
      button.classList.toggle('active', i === paginaAtual);
      button.addEventListener('click', () => {
        paginaAtual = i;
        atualizarTabela();
      });
      paginationContainer.appendChild(button);
    }

    // ultima pagina
    if (endPage < totalPaginas) {
      const ellipsis = document.createElement('span');
      ellipsis.textContent = '...';
      paginationContainer.appendChild(ellipsis);

      const lastPageButton = document.createElement('button');
      lastPageButton.textContent = totalPaginas;
      lastPageButton.addEventListener('click', () => {
        paginaAtual = totalPaginas;
        atualizarTabela();
      });
      paginationContainer.appendChild(lastPageButton);
    }

    // Add "Próximo" button
    const proximoButton = document.createElement('button');
    proximoButton.textContent = 'Próximo';
    proximoButton.addEventListener('click', () => {
      if (paginaAtual < totalPaginas) {
        paginaAtual++;
        atualizarTabela();
      }
    });
    paginationContainer.appendChild(proximoButton);
  }
  function atualizarPaginacaoToupu() {
    const totalPaginas = Math.ceil(registrosToupu.length / itensPorPaginaToupu);
    const paginationContainer = document.getElementById('paginationToupu');
    paginationContainer.innerHTML = '';

    // Add "Anterior" button
    const anteriorButton = document.createElement('button');
    anteriorButton.textContent = 'Anterior';
    anteriorButton.addEventListener('click', () => {
      if (paginaAtualToupu > 1) {
        paginaAtualToupu--;
        atualizarTabelaToupu();
      }
    });
    paginationContainer.appendChild(anteriorButton);

    // Calculate range of pages to show
    let startPage = Math.max(1, paginaAtualToupu - 2);
    let endPage = Math.min(totalPaginas, startPage + 4);
    
    if (endPage - startPage < 4) {
      startPage = Math.max(1, endPage - 4);
    }

    // Add page buttons
    for (let i = startPage; i <= endPage; i++) {
      const button = document.createElement('button');
      button.textContent = i;
      button.classList.toggle('active', i === paginaAtualToupu);
      button.addEventListener('click', () => {
        paginaAtualToupu = i;
        atualizarTabelaToupu();
      });
      paginationContainer.appendChild(button);
    }

    // ultima pagina
    if (endPage < totalPaginas) {
      const ellipsis = document.createElement('span');
      ellipsis.textContent = '...';
      paginationContainer.appendChild(ellipsis);

      const lastPageButton = document.createElement('button');
      lastPageButton.textContent = totalPaginas;
      lastPageButton.addEventListener('click', () => {
        paginaAtualToupu = totalPaginas;
        atualizarTabelaToupu();
      });
      paginationContainer.appendChild(lastPageButton);
    }

    // Add "Próximo" button
    const proximoButton = document.createElement('button');
    proximoButton.textContent = 'Próximo';
    proximoButton.addEventListener('click', () => {
      if (paginaAtualToupu < totalPaginas) {
        paginaAtualToupu++;
        atualizarTabelaToupu();
      }
    });
    paginationContainer.appendChild(proximoButton);
  }
  function filtrarRegistros() {
    const termo = document.getElementById('searchInput').value.toLowerCase();
    const registrosFiltrados = registros.filter(registro => 
      Object.values(registro).some(valor => 
        valor.toString().toLowerCase().includes(termo)
      )
    );
    
    const tbody = document.querySelector('#registrosTable tbody');
    tbody.innerHTML = '';
    
    registrosFiltrados.forEach((registro, index) => {
      const tr = document.createElement('tr');
      if (registro.etiquetasUsadas === registro.etiquetasNecessarias) {
        tr.classList.add('used-all');
      }
      const etiquetasCompletas = registro.etiquetasNecessarias - (registro.pecasExtras > 0 ? 1 : 0);
      tr.innerHTML = `
        <td>${registro.id}</td>
        <td>${registro.data}</td>
        <td>${registro.codigoPeca}</td>
        <td>${registro.numeroLote}</td>
        <td>${registro.totalPecas}</td>
        <td>${registro.pecasPorCaixa}</td>
        <td>${registro.pecasExtras}</td>
        <td>${registro.etiquetasNecessarias}${registro.pecasExtras > 0 ? ` (${etiquetasCompletas} completas + 1 extra)` : ''}</td>
        <td contenteditable="true" oninput="atualizarEtiquetasUsadas(${registros.indexOf(registro)}, this)">${registro.etiquetasUsadas}</td>
        <td>${registro.observacoes}</td>
        <td>
          <button class="edit-btn" onclick="editarRegistro(${registro.id})">✏️</button>
           <button class="delete-btn" onclick="confirmarExclusaoRegistro(${registro.id})">🗑️</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
  function filtrarRegistrosToupu() {
    const termo = document.getElementById('searchInputToupu').value.toLowerCase();
    const registrosFiltrados = registrosToupu.filter(registro => 
      Object.values(registro).some(valor => 
        valor.toString().toLowerCase().includes(termo)
      )
    );
    
    const tbody = document.querySelector('#registrosToupuTable tbody');
    tbody.innerHTML = '';
    
    const inicio = (paginaAtualToupu - 1) * itensPorPaginaToupu;
    const fim = inicio + itensPorPaginaToupu;
    const registrosPagina = registrosFiltrados.slice(inicio, fim);
    
    registrosPagina.forEach((registro, index) => {
      const tr = document.createElement('tr');
      if (registro.etiquetasUsadas === registro.etiquetasNecessarias) {
        tr.classList.add('used-all');
      }
      const etiquetasInfo = registro.pecasExtras > 0 
        ? `${registro.etiquetasCompletas} + 1 extra (${registro.pecasExtras} peças)`
        : `${registro.etiquetasNecessarias}`;
      tr.innerHTML = `
        <td>${registro.id}</td>
        <td>${registro.data}</td>
        <td>${registro.codigoPeca}</td>
        <td>${registro.numeroLote}</td>
        <td>${registro.pecasPorSaco}</td>
        <td>${registro.sacosPorPalete}</td>
        <td>${registro.totalPaletes}</td>
        <td>${etiquetasInfo}</td>
        <td contenteditable="true" oninput="atualizarEtiquetasUsadasToupu(${index}, this)">${registro.etiquetasUsadas}</td>
        <td>${registro.observacoes}</td>
        <td>
          <button class="delete-btn" onclick="excluirRegistroToupu(${registro.id})">🗑️</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    atualizarPaginacaoToupu();
  }

  // 6. Funçoes para manipular eventos
  function atualizarEtiquetasUsadas(index, element) {
    // Obtém o valor atual e tenta convertê-lo para um número inteiro
    let valor = parseInt(element.textContent);
    const registro = registros[index];
    
    // Valida o valor
    if (isNaN(valor) || valor < 0) {
      valor = 0; // Se o valor não for um número ou for negativo, define como 0
    } else if (valor > registro.etiquetasNecessarias) {
      valor = registro.etiquetasNecessarias; // Limita o valor ao máximo de etiquetas necessárias
    }
    
    // Atualiza o registro com o novo valor de etiquetas usadas
    registro.etiquetasUsadas = valor;
    element.textContent = valor; // Atualiza o elemento na interface

    // Adiciona ou remove a classe 'used-all' na linha da tabela com base no valor
    if (valor === registro.etiquetasNecessarias) {
      element.closest('tr').classList.add('used-all');
    } else {
      element.closest('tr').classList.remove('used-all');
    }
    
    // Salva as alterações no armazenamento local e no Firebase
    salvarLocalStorage();
    atualizarRegistroFirebase(registro);
  }
  function atualizarEtiquetasUsadasToupu(index, element) {
    let valor = parseInt(element.textContent);
    const registro = registrosToupu[index];
    
    // Verifica se o valor é válido
    if (isNaN(valor) || valor < 0) {
      valor = 0;
    } else if (valor > registro.etiquetasNecessarias) {
      valor = registro.etiquetasNecessarias;
    }
    
    // Atualiza o registro e o conteúdo do elemento
    registro.etiquetasUsadas = valor;
    element.textContent = valor;
    
    // Adiciona ou remove classe baseado na quantidade de etiquetas usadas
    if (valor === registro.etiquetasNecessarias) {
      element.closest('tr').classList.add('used-all');
    } else {
      element.closest('tr').classList.remove('used-all');
    }
    
    // Salva as alterações
    salvarLocalStorageToupu(); //  função para salvar dados Toupu
    atualizarRegistroToupuFirebase(registro);//  função para atualizar registro Firebase para Toupu
  }
  function editarRegistro(id) {
    const index = registros.findIndex(r => r.id === id);
    if (index !== -1) {
      const registro = registros[index];
      document.getElementById('editIndex').value = index;
      document.getElementById('editCodigoPeca').value = registro.codigoPeca;
      document.getElementById('editNumeroLote').value = registro.numeroLote;
      document.getElementById('editEtiquetasNecessarias').value = registro.etiquetasNecessarias;
      document.getElementById('editPecasExtras').value = registro.pecasExtras;
      document.getElementById('editObservacoes').value = registro.observacoes;
      document.getElementById('editModal').style.display = 'block';
      atualizarCalculosEdicao();
    } else {
      alert("ID de registro inválido.");
    }
  }

  function atualizarCalculosEdicao() {
    const index = document.getElementById('editIndex').value;
    const etiquetasNecessarias = parseInt(document.getElementById('editEtiquetasNecessarias').value) || 0;
    const pecasExtras = parseInt(document.getElementById('editPecasExtras').value) || 0;
    const pecasPorCaixa = registros[index].pecasPorCaixa;
    
    if (pecasExtras >= pecasPorCaixa) {
      document.getElementById('editPecasExtras').value = pecasPorCaixa - 1;
      return atualizarCalculosEdicao();
    }
    
    const totalPecas = etiquetasNecessarias * pecasPorCaixa + pecasExtras;
    const etiquetasReais = etiquetasNecessarias + (pecasExtras > 0 ? 1 : 0);
    
    document.getElementById('editTotalPecas').textContent = `Total de Peças: ${totalPecas}`;
    document.getElementById('editEtiquetasNecessariasCalc').textContent = `Etiquetas Necessárias: ${etiquetasReais}${pecasExtras > 0 ? ` (${etiquetasNecessarias} completas + 1 extra)` : ''}`;
  }

  document.getElementById('editEtiquetasNecessarias').addEventListener('input', atualizarCalculosEdicao);
  document.getElementById('editPecasExtras').addEventListener('input', atualizarCalculosEdicao);

  function excluirRegistro(id) {
    const index = registros.findIndex(r => r.id === id);
    if (index !== -1) {
      if (confirm(`Tem certeza que deseja excluir o registro ${id}?`)) {
        registros.splice(index, 1);
        atualizarTabela();
        salvarLocalStorage();
        excluirRegistroFirebase(id);
        atualizarTabela();
salvarLocalStorage();
      }
    } else {
      alert("ID de registro inválido.");
    }
  }

  function excluirRegistroToupu(id) {
    const index = registrosToupu.findIndex(r => r.id === id);
    
    // Verifica se o registro foi encontrado
    if (index !== -1) {
      // Confirma a exclusão
      if (confirm(`Tem certeza que deseja excluir o registro ${id}?`)) {
        registrosToupu.splice(index, 1); // Remove o registro
        atualizarTabelaToupu(); // Atualiza a tabela
        salvarLocalStorageToupu(); // Salva as alterações no localStorage
        excluirRegistroToupuFirebase(id); // Chama a função para excluir do Firebase
      }
    } else {
      alert("Registro não encontrado."); // Mensagem mais clara
    }
  }

  document.getElementById('cancelarExclusaoToupuBtn').addEventListener('click', function() {
  document.getElementById('confirmarExclusaoToupuModal').style.display = 'none';
});

document.querySelector('#confirmarExclusaoToupuModal .close').addEventListener('click', function() {
  document.getElementById('confirmarExclusaoToupuModal').style.display = 'none';
});

  // 7. funçoes de calcular
  
  function calcularEtiquetas() {
    const codigoPeca = document.getElementById('codigoPeca').value;
    const numeroLote = document.getElementById('numeroLote').value;
    const totalPecas = parseInt(document.getElementById('totalPecas').value);
    const pecasPorCaixa = parseInt(document.getElementById('pecasPorCaixa').value);
    const observacoes = document.getElementById('observacoes').value;

    if (!totalPecas || !pecasPorCaixa) {
        alert('Por favor, preencha os campos obrigatórios.');
        return;
    }

    const etiquetasNecessarias = Math.ceil(totalPecas / pecasPorCaixa);
    const etiquetasCompletas = Math.floor(totalPecas / pecasPorCaixa);
    const pecasExtras = totalPecas % pecasPorCaixa;

    const resultado = 
    `Total de etiquetas: ${etiquetasNecessarias} <br>
    ${pecasExtras > 0 ? `(${etiquetasCompletas} completas + ${pecasExtras} extra com ${pecasExtras} peças)` : ''}`;

    document.getElementById('resultado').innerHTML = resultado;
    document.getElementById('resultado').style.display = 'block';
    document.getElementById('resultadoToupu').style.display = 'none';

  /*
 // Verificação de duplicidade para registros normais
 const registroExistente = registros.find(r => r.codigoPeca === codigoPeca && r.numeroLote === numeroLote);
 if (registroExistente) {
     alert('Registro já existe!');
     return; // Não prossegue com a criação do novo registro
 }
*/
    const novoRegistro = {
        id: nextId++,
        data: new Date().toLocaleString(),
        codigoPeca,
        numeroLote,
        totalPecas,
        pecasPorCaixa,
        etiquetasNecessarias,
        pecasExtras,
        etiquetasUsadas: 0,
        observacoes
    };

    registros.unshift(novoRegistro);
    salvarRegistroFirebase(novoRegistro);
    

     // Atualizar o localStorage com as palavras
updateLocalStorageWithWords();

// Carregar sugestões do localStorage
loadSuggestionsFromLocalStorage();

// Carregar sugestões do localStorage ao iniciar
document.addEventListener('DOMContentLoaded', loadSuggestionsFromLocalStorage);


    // Aqui está o ponto importante
    const mostrarCalculos = document.getElementById('mostrarCalculos').checked;
    if (mostrarCalculos) {
        const calculosDetalhados = `
            <p>Total de Peças: ${totalPecas}</p>
            <p>Peças por Caixa: ${pecasPorCaixa}</p>
            <p>Matemática:</p>
            <p>${totalPecas} / ${pecasPorCaixa} = ${totalPecas / pecasPorCaixa}</p>
            <p>${etiquetasCompletas} * ${pecasPorCaixa} = ${etiquetasCompletas * pecasPorCaixa}</p>
            <p>${totalPecas} - ${etiquetasCompletas * pecasPorCaixa} = ${pecasExtras}</p>
        `;
        document.getElementById('calculosConteudo').innerHTML = calculosDetalhados;
        document.getElementById('calculosDetalhados').style.display = 'block'; // Certifique-se de que isso está ativando a exibição
    } else {
        document.getElementById('calculosDetalhados').style.display = 'none'; // Caso contrário, esconda
    }


    saveSuggestionToFirebase(codigoPeca, numeroLote); // Salva sugestões no Firebase
    atualizarTabela();
}

  function calcularEtiquetasToupu() {
    const codigoPeca = document.getElementById('codigoPecaToupu').value;
    const numeroLote = document.getElementById('numeroLoteToupu').value;
    const totalPecas = parseInt(document.getElementById('totalPecasToupu').value);
    const observacoes = document.getElementById('observacoesToupu').value;

    if (!codigoPeca || !totalPecas) {
      alert('Por favor, preencha os campos obrigatórios.');
      return;
    }

    const toupuData = toupuCodes[codigoPeca];
    if (!toupuData) {
      alert('Código Toupu inválido.');
      return;
    }

    const totalPaletes = Math.ceil(totalPecas / toupuData.totalPorPalete);
    const sacosCompletos = Math.floor(totalPecas / toupuData.pecasPorSaco);
    const pecasExtras = totalPecas % toupuData.pecasPorSaco;
    const etiquetasNecessarias = sacosCompletos + (pecasExtras > 0 ? 1 : 0);

    const resultado = `Total de paletes: ${totalPaletes}, Etiquetas necessárias: ${etiquetasNecessarias}${pecasExtras > 0 ? ` (${sacosCompletos} completas + 1 extra com ${pecasExtras} peças)` : ''}`;
    document.getElementById('resultadoToupu').textContent = resultado;
    document.getElementById('resultadoToupu').style.display = 'block';
    document.getElementById('resultado').style.display = 'none';

       /*
 // Verificação de duplicidade para registros Toupu
 const registroExistenteToupu = registrosToupu.find(r => r.codigoPeca === codigoPeca && r.numeroLote === numeroLote);
 if (registroExistenteToupu) {
     alert('Registro já existe no modo Toupu!');
     return; // Não prossegue com a criação do novo registro
 }
*/


    const novoRegistro = {
      id: `T${nextIdToupu++}`,
      data: new Date().toLocaleString(),
      codigoPeca,
      numeroLote,
      pecasPorSaco: toupuData.pecasPorSaco,
      sacosPorPalete: toupuData.sacosPorPalete,
      totalPaletes,
      etiquetasNecessarias,
      etiquetasCompletas: sacosCompletos,
      pecasExtras,
      etiquetasUsadas: 0,
      totalPecas,
      observacoes
    };

    registrosToupu.unshift(novoRegistro);
    salvarRegistroToupuFirebase(novoRegistro);
    atualizarTabelaToupu();

    const mostrarCalculos = document.getElementById('mostrarCalculos').checked;
    if (mostrarCalculos) {
      const calculosToupuDetalhados = `
        <p>Total de Peças: ${totalPecas}</p>
        <p>Peças por Saco: ${toupuData.pecasPorSaco}</p>
        <p>Matemática:</p>
        <p>${totalPecas} / ${toupuData.pecasPorSaco} = ${totalPecas / toupuData.pecasPorSaco}</p>
        <p>${sacosCompletos} * ${toupuData.pecasPorSaco} = ${sacosCompletos * toupuData.pecasPorSaco}</p>
        <p>${totalPecas} - ${sacosCompletos * toupuData.pecasPorSaco} = ${pecasExtras}</p>
      `;
      document.getElementById('calculosToupuConteudo').innerHTML = calculosToupuDetalhados;
      document.getElementById('calculosToupuDetalhados').style.display = 'block';
      
    } else {
      document.getElementById('calculosToupuDetalhados').style.display = 'none';
    }
  }

  // 8. funçoes exportar dados
  function salvarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const allRegistros = [...registros, ...registrosToupu];
    allRegistros.sort((a, b) => new Date(b.data) - new Date(a.data));

    // Título - Fundo azul escuro e texto branco
    doc.setFillColor(0, 51, 153); // Azul escuro
    doc.rect(10, 10, 190, 10, 'F'); // Fundo do título
    doc.setTextColor(255, 255, 255); // Texto branco
    doc.setFontSize(14);
    
    // Texto do título
    doc.text("Relatório de registros", 14, 17);

    // Adiciona a data do documento no canto superior direito
    const dataAtual = new Date().toLocaleDateString('pt-BR');
    doc.text(`criado em: ${dataAtual}`, 130, 17); // Alinha à direita com o texto "Relatório criado em:"

    // Resetando cores para a tabela
    doc.setTextColor(0, 0, 0); // Texto preto para o conteúdo da tabela

    const columns = [
      "ID", "Data", "Código", "Lote", "Total de\nPeças", "Peças por\nCaixa",
      "Peças\nExtras", "Etiquetas\nNecessárias", "Etiquetas\nUsadas", "Observações"
    ];

    const data = registros.map(r => [
      r.id, r.data, r.codigoPeca, r.numeroLote, r.totalPecas, r.pecasPorCaixa,
      r.pecasExtras, r.etiquetasNecessarias, r.etiquetasUsadas, r.observacoes
    ]);

    // Configurações da tabela
    doc.autoTable({
      head: [columns],
      body: data,
      startY: 30, // Abaixo do título
      theme: 'grid',
      styles: {
        fontSize: 7, // Diminuindo o tamanho da fonte
        cellPadding: 2, // Reduzindo o espaçamento entre as células
        minCellHeight: 8, // Altura mínima das células
        textColor: [0, 0, 0], // Texto preto
        valign: 'middle', // Alinhamento vertical no meio
        halign: 'center' // Alinhamento à esquerda
      },
      headStyles: {
        fillColor: [0, 0, 128], // Azul escuro no cabeçalho
        textColor: [255, 255, 255], // Texto branco no cabeçalho
        fontSize: 9, // Tamanho da fonte do cabeçalho
        halign: 'center' // Texto centralizado nos títulos das colunas
        },
        alternateRowStyles: {
            fillColor: [224, 247, 250]
          },
      columnStyles: {
        0: { cellWidth: 'auto' }, 
        1: { cellWidth: 'auto' },
        4: { cellWidth: 'auto' }, // "Total de Peças"
        5: { cellWidth: 'auto' }, // "Peças por Caixa"
        6: { cellWidth: 'auto' }, // "Peças Extras"
        7: { cellWidth: 'auto' }, // "Etiquetas Necessárias"
        8: { cellWidth: 'auto' }  // "Etiquetas Usadas"
      },
      bodyStyles: function (data, rowIndex) {
        // Alternar fundo das linhas
        return {
          fillColor: rowIndex % 2 === 0 ? [240, 240, 240] : [173, 216, 230] // Alternância de fundo
        };
      }
    });

    // Salvando o documento
    doc.save(`RelatorioGeral ${dataAtual}.pdf`);

    // Criando um novo documento para os registros Toupu
    const docToupu = new jsPDF();

      // Título - Fundo azul escuro e texto branco
      docToupu.setFillColor(0, 51, 153); // Azul escuro
      docToupu.rect(10, 10, 190, 10, 'F'); // Fundo do título
      docToupu.setTextColor(255, 255, 255); // Texto branco
      docToupu.setFontSize(14);
    
    // Título da tabela Toupu
    docToupu.text("Relatório de Registros Toupu", 14, 17);


    // Adiciona a data do documento no canto superior direito
    docToupu.text(`criado em: ${dataAtual}`, 130, 17); // Alinha à direita com o texto "Relatório

    const columnsToupu = [
      "ID", "Data", "Código", "Lote", "Peças\npor Saco", "Sacos por\nPalete",
      "Etiquetas\nNecessárias ", "Etiquetas\nUsadas", "Total de\n Paletes", "Observações"
    ];

    const dataToupu = registrosToupu.map(r => [
      r.id, r.data, r.codigoPeca, r.numeroLote, r.pecasPorSaco, r.sacosPorPalete,
      r.etiquetasNecessarias, r.etiquetasUsadas, r.totalPaletes, r.observacoes
    ]);

    // Configurações da tabela Toupu
    docToupu.autoTable({
      head: [columnsToupu],
      body: dataToupu,
      startY: 20,
      theme: 'grid',
      styles: {
        fontSize: 7, // Diminuindo o tamanho da fonte
        cellPadding: 2, // Reduzindo o espaçamento entre as células
        minCellHeight: 8, // Altura mínima das células
        textColor: [0, 0, 0], // Texto preto
        valign: 'middle', // Alinhamento vertical no meio
        halign: 'center' // Alinhamento à esquerda
      },
      headStyles: {
        fillColor: [0, 0, 128], // Azul escuro no cabeçalho
        textColor: [255, 255, 255], // Texto branco no cabeçalho
        fontSize: 9, // Tamanho da fonte do cabeçalho
        halign: 'center' // Texto centralizado nos títulos das colunas
      },
      alternateRowStyles: {
            fillColor: [224, 247, 250]
          },
      columnStyles: {
        0: { cellWidth: 'auto' }, 
        1: { cellWidth: 'auto' },
        4: { cellWidth: 'auto' }, // "Total de Peças"
        5: { cellWidth: 'auto' }, // "Peças por Caixa"
        6: { cellWidth: 'auto' }, // "Peças Extras"
        7: { cellWidth: 'auto' }, // "Etiquetas Necessárias"
        8: { cellWidth: 'auto' }  // "Etiquetas Usadas"
      },
      bodyStyles: function (data, rowIndex) {
        // Alternar fundo das linhas
        return {
          fillColor: rowIndex % 2 === 0 ? [240, 240, 240] : [173, 216, 230] // Alternância de fundo
        };
      }
    });

    // Salvando o documento
    docToupu.save(`RelatorioToupu ${dataAtual}.pdf`);
  }
  function salvarXLSX() {
    // Cria uma nova pasta de trabalho (workbook) e planilha (worksheet)
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet([]);

    // Define o título do relatório e a data
    const title = "Relatório de registros de etiquetas";
    const date = new Date();
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0'); // Janeiro é 0
    const year = date.getFullYear();
    const formattedDate = `${day}-${month}-${year}`; // Formata para DD-MM-YYYY
    const readableDate = date.toLocaleDateString('pt-BR'); // Para exibir no relatório
    XLSX.utils.sheet_add_aoa(ws, [[`${title} criado em: ${readableDate}`]], { origin: 'A1' });

    // Cabeçalhos da planilha
    const headers = [
      "ID", "Data", "Código", "Lote", "Total de Peças", "Peças por Caixa",
      "Peças Extras", "Etiquetas Necessárias", "Etiquetas Usadas", "Observações"
    ];
    XLSX.utils.sheet_add_aoa(ws, [headers], { origin: 'A2' });

    // Adiciona os dados dos registros
    const data = registros.map(r => [
      r.id, r.data, r.codigoPeca, r.numeroLote, r.totalPecas, r.pecasPorCaixa,
      r.pecasExtras, r.etiquetasNecessarias, r.etiquetasUsadas, r.observacoes
    ]);
    XLSX.utils.sheet_add_aoa(ws, data, { origin: 'A3' });

    // Definir a largura das colunas
    const colWidths = [10, 20, 15, 15, 15, 15, 15, 20, 15, 30];
    ws['!cols'] = colWidths.map(w => ({ wch: w }));

    // Estilo do cabeçalho
    const headerStyle = {
      fill: { fgColor: { rgb: "000080" } }, // Cor de fundo azul escuro
      font: { color: { rgb: "FFFFFF" }, bold: true }, // Texto branco e negrito
      alignment: { horizontal: "center", vertical: "center" } // Alinhamento centralizado
    };

    // Estilo para as linhas pares e ímpares
    const evenRowStyle = { fill: { fgColor: { rgb: "E6E6E6" } }, alignment: { horizontal: "center" } }; // Cinza claro para linhas pares
    const oddRowStyle = { fill: { fgColor: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } }; // Branco para linhas ímpares

    // Centralizar o título
    const titleCell = XLSX.utils.encode_cell({ r: 0, c: 0 });
    if (!ws[titleCell]) ws[titleCell] = {};
    ws[titleCell].s = { alignment: { horizontal: "center" } };

    // Aplicar estilo ao cabeçalho
    for (let i = 0; i < headers.length; i++) {
      const cell = XLSX.utils.encode_cell({ r: 1, c: i });
      if (!ws[cell]) ws[cell] = {};
      ws[cell].s = headerStyle;
    }

    // Aplicar estilo às linhas de dados (alternando cores e centralizando)
    for (let i = 0; i < data.length; i++) {
      const rowStyle = i % 2 === 0 ? evenRowStyle : oddRowStyle; // Alterna a cor das linhas
      for (let j = 0; j < headers.length; j++) {
        const cell = XLSX.utils.encode_cell({ r: i + 2, c: j });
        if (!ws[cell]) ws[cell] = {};
        ws[cell].s = rowStyle;
      }
    }

    // Criar uma nova planilha para os registros Toupu
    const wsToupu = XLSX.utils.json_to_sheet([]);

    // Define o título do relatório e a data
    const titleToupu = "Relatório de Registros Toupu";
    XLSX.utils.sheet_add_aoa(wsToupu, [[`${titleToupu} criado em: ${readableDate}`]], { origin: 'A1' });

    // Cabeçalhos da planilha
    const headersToupu = [
      "ID", "Data", "Código", "Lote", "Peças por Saco", "Sacos por Palete",
      "Etiquetas Necessárias", "Etiquetas Usadas", "Total de Paletes", "Observações"
    ];
    XLSX.utils.sheet_add_aoa(wsToupu, [headersToupu], { origin: 'A2' });

    // Adiciona os dados dos registros Toupu
    const dataToupu = registrosToupu.map(r => [
      r.id, r.data, r.codigoPeca, r.numeroLote, r.pecasPorSaco, r.sacosPorPalete,
      r.etiquetasNecessarias, r.etiquetasUsadas, r.totalPaletes, r.observacoes
    ]);
    XLSX.utils.sheet_add_aoa(wsToupu, dataToupu, { origin: 'A3' });

    // Definir a largura das colunas
    const colWidthsToupu = [10, 20, 15, 15, 15, 15, 20, 15, 15, 30];
    wsToupu['!cols'] = colWidthsToupu.map(w => ({ wch: w }));

    // Estilo do cabeçalho
    const headerStyleToupu = {
      fill: { fgColor: { rgb: "000080" } }, // Cor de fundo azul escuro
      font: { color: { rgb: "FFFFFF" }, bold: true }, // Texto branco e negrito
      alignment: { horizontal: "center", vertical: "center" } // Alinhamento centralizado
    };

    // Estilo para as linhas pares e ímpares
    const evenRowStyleToupu = { fill: { fgColor: { rgb: "E6E6E6" } }, alignment: { horizontal: "center" } }; // Cinza claro para linhas pares
    const oddRowStyleToupu = { fill: { fgColor: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } }; // Branco para linhas ímpares

    // Centralizar o título
    const titleCellToupu = XLSX.utils.encode_cell({ r: 0, c: 0 });
    if (!wsToupu[titleCellToupu]) wsToupu[titleCellToupu] = {};
    wsToupu[titleCellToupu].s = { alignment: { horizontal: "center" } };

    // Aplicar estilo ao cabeçalho
    for (let i = 0; i < headersToupu.length; i++) {
      const cell = XLSX.utils.encode_cell({ r: 1, c: i });
      if (!wsToupu[cell]) wsToupu[cell] = {};
      wsToupu[cell].s = headerStyleToupu;
    }

    // Aplicar estilo às linhas de dados (alternando cores e centralizando)
    for (let i = 0; i < dataToupu.length; i++) {
      const rowStyle = i % 2 === 0 ? evenRowStyleToupu : oddRowStyleToupu; // Alterna a cor das linhas
      for (let j = 0; j < headersToupu.length; j++) {
        const cell = XLSX.utils.encode_cell({ r: i + 2, c: j });
        if (!wsToupu[cell]) wsToupu[cell] = {};
        wsToupu[cell].s = rowStyle;
      }
    }

    // Adicionar as planilhas ao livro e salvar os arquivos
    XLSX.utils.book_append_sheet(wb, ws, "Registros Gerais");
    XLSX.utils.book_append_sheet(wb, wsToupu, "Registros Toupu");
    XLSX.writeFile(wb, `Relatorio_Registros_Completo_${formattedDate}.xlsx`); // Inclui a data no nome do arquivo
  }

  // 9. funçoes gerenciar modal
  function mostrarAcoes() {
    document.getElementById('acoesModal').style.display = 'block';
  }
  function confirmarApagarTodos() {
      document.getElementById('confirmarApagarTodosModal').style.display = 'block';
    }
  function apagarTodosRegistros() {
    const senha = document.getElementById('senhaAdmin').value;
    if (senha === "Medeiros") {
      registros = [];
      registrosToupu = [];
      nextId = 1;
      nextIdToupu = 1;
      atualizarTabela();
      atualizarTabelaToupu();
      salvarLocalStorage();
      salvarLocalStorageToupu();
      db.collection("registros").get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          doc.ref.delete();
        });
      });
      db.collection("registrosToupu").get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          doc.ref.delete();
        });
      });
      fecharModal();
    } else {
      alert("Senha incorreta.");
    }
  }
  function confirmarExclusaoRegistro(id) {
    registroParaExcluir = id;
    document.getElementById('confirmarExclusaoModal').style.display = 'block';
  }
  function excluirRegistroConfirmado() {
    if (registroParaExcluir !== null) {
      const index = registros.findIndex(r => r.id === registroParaExcluir);
      if (index !== -1) {
        registros.splice(index, 1);
        atualizarTabela();
        salvarLocalStorage();
        excluirRegistroFirebase(registroParaExcluir);
      }
      fecharModal();
      registroParaExcluir = null;
    }
  }
  function confirmarExclusaoRegistroToupu(id) {
  registroParaExcluirToupu = id;
  document.getElementById('confirmarExclusaoToupuModal').style.display = 'block';
}

function excluirRegistroToupuConfirmado() {
  if (registroParaExcluirToupu !== null) {
    const index = registrosToupu.findIndex(r => r.id === registroParaExcluirToupu);
    if (index !== -1) {
      registrosToupu.splice(index, 1);
      atualizarTabelaToupu();
      salvarLocalStorageToupu();
      excluirRegistroToupuFirebase(registroParaExcluirToupu);
    }
    registroParaExcluirToupu = null;
    document.getElementById('confirmarExclusaoToupuModal').style.display = 'none';
  }
}

document.getElementById('confirmarExclusaoToupuBtn').addEventListener('click', excluirRegistroToupuConfirmado);
document.getElementById('cancelarExclusaoToupuBtn').addEventListener('click', fecharModal);
  function fecharModal() {
    // Oculta todos os modais
    document.getElementById('acoesModal').style.display = 'none';
    document.getElementById('confirmarApagarModal').style.display = 'none';
    document.getElementById('editModal').style.display = 'none';
    document.getElementById('calculosModal').style.display = 'none';
    document.getElementById('confirmarExclusaoModal').style.display = 'none';
  }

  // Adiciona evento para botões de fechar
  document.querySelectorAll('.close').forEach(closeBtn => {
    closeBtn.addEventListener('click', fecharModal);
  });

  // Botão para cancelar exclusão
  document.getElementById('cancelarExclusaoBtn').addEventListener('click', fecharModal);

  // Botão para confirmar exclusão
  document.getElementById('confirmarExclusaoBtn').addEventListener('click', excluirRegistroConfirmado);

  // Botão para salvar edição e fechar modal
  document.getElementById('salvarEdicao').addEventListener('click', () => {
    const index = document.getElementById('editIndex').value;
    const etiquetasNecessarias = parseInt(document.getElementById('editEtiquetasNecessarias').value);
    const pecasExtras = parseInt(document.getElementById('editPecasExtras').value);
    const pecasPorCaixa = registros[index].pecasPorCaixa;
    
    if (pecasExtras >= pecasPorCaixa) {
      document.getElementById('editPecasExtras').value = pecasPorCaixa - 1;
      return atualizarCalculosEdicao();
    }
    
    const totalPecas = etiquetasNecessarias * pecasPorCaixa + pecasExtras;
    const etiquetasReais = etiquetasNecessarias + (pecasExtras > 0 ? 1 : 0);

    // Atualiza registro
    registros[index] = {
      ...registros[index],
      codigoPeca: document.getElementById('editCodigoPeca').value,
      numeroLote: document.getElementById('editNumeroLote').value,
      totalPecas: totalPecas,
      etiquetasNecessarias: etiquetasReais,
      pecasExtras: pecasExtras,
      etiquetasUsadas: etiquetasReais,
      observacoes: document.getElementById('editObservacoes').value
    };
    
    atualizarTabela();
    salvarLocalStorage();
    atualizarRegistroFirebase(registros[index]);
    fecharModal();
  });

  // 10. inicialização e configuração
  function setupAutocomplete() {
    const inputs = ['codigoPeca', 'numeroLote', 'observacoes'];
    inputs.forEach(inputId => {
      const input = document.getElementById(inputId);
      const datalist = document.createElement('datalist');
      datalist.id = `${inputId}List`;
      input.setAttribute('list', datalist.id);
      document.body.appendChild(datalist);

      input.addEventListener('input', () => {
        updateAutocompleteOptions(inputId, input.value);
      });
    });
  }

// Função para atualizar sugestões de autocomplete
function updateAutocompleteOptions(inputId, value) {
    const datalist = document.getElementById(`${inputId}List`);
    datalist.innerHTML = '';
    const options = [...new Set(registros.map(r => r[inputId]))]
        .filter(v => v && v.toLowerCase().includes(value.toLowerCase()))
        .slice(0, 15); // Limita a 15 sugestões

    options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        datalist.appendChild(optionElement);
    });
}

// Função para adicionar evento de input aos campos
function addInputEvent(inputId) {
  const input = document.getElementById(inputId);
  input.addEventListener('input', () => {
    saveData(inputId, input.value);
    updateAutocompleteOptions(inputId, input.value);
  });
}

// Adiciona eventos de input aos campos
inputFields.forEach(addInputEvent);


  setupAutocomplete();



  // Função para atualizar a exibição dos elementos com base no modo Toupu
  function atualizarExibicaoToupu(isToupuMode) {
    // Oculta ou mostra elementos com base no modo Toupu
    document.querySelector('.normal-inputs').style.display = isToupuMode ? 'none' : 'flex';
    document.querySelector('.toupu-inputs').style.display = isToupuMode ? 'flex' : 'none';
    document.getElementById('registrosTable').style.display = isToupuMode ? 'none' : 'table';
    document.getElementById('registrosToupuTable').style.display = isToupuMode ? 'table' : 'none';
    document.querySelector('.normal-search').style.display = isToupuMode ? 'none' : 'block';
    document.querySelector('.toupu-search').style.display = isToupuMode ? 'block' : 'none';
    document.getElementById('calculosToupuDetalhados').style.display = 'none';
  }

  // Adiciona ouvintes de eventos aos elementos do DOM
  
   // Switch do Modo Toupu para manter ligado/desligado "ON e OFF"
document.getElementById('toggleToupu').addEventListener('change', function() {
    const isToupuMode = this.checked;
    localStorage.setItem('isToupuMode', isToupuMode); // Salva o estado no localStorage
    toggleToupuMode();
});
// Switch do Mostrar Cálculos para manter ligado/desligado "ON e OFF"
document.getElementById('mostrarCalculos').addEventListener('change', function() {
    const mostrarCalculos = this.checked;
    localStorage.setItem('mostrarCalculos', mostrarCalculos); // Salva o estado no localStorage
    document.getElementById('calculosDetalhados').style.display = mostrarCalculos ? 'block' : 'none'; // Atualiza a exibição
});

  //ouvinte da caixa de lote repetido, para mudar a cor azul e vermelho modo normal
  document.getElementById('numeroLote').addEventListener('input', function() {
    verificarLote(this.value);
    });
  //ouvinte da caixa de lote repetido, para mudar a cor azul e vermelho modo toupu
    document.getElementById('numeroLoteToupu').addEventListener('input', function() {
    verificarLoteToupu(this.value);
});

  document.getElementById('calcular').addEventListener('click', calcularEtiquetas);
  document.getElementById('calcularToupu').addEventListener('click', calcularEtiquetasToupu);
  document.getElementById('searchInput').addEventListener('input', filtrarRegistros);
  document.getElementById('searchInputToupu').addEventListener('input', filtrarRegistrosToupu);
  document.getElementById('salvarPDF').addEventListener('click', salvarPDF);
  document.getElementById('salvarXLSX').addEventListener('click', salvarXLSX);
  document.getElementById('acoes').addEventListener('click', mostrarAcoes);
  document.getElementById('sairAcoes').addEventListener('click', fecharModal);
  document.getElementById('apagarTodos').addEventListener('click', confirmarApagarTodos);
  document.getElementById('confirmarApagar').addEventListener('click', apagarTodosRegistros);
  document.getElementById('toggleToupu').addEventListener('change', toggleToupuMode);

  // Controla a exibição dos cálculos detalhados
  document.getElementById('mostrarCalculos').addEventListener('change', function() {
    document.getElementById('calculosToupuDetalhados').style.display = this.checked ? 'block' : 'none';
  });

  document.getElementById('confirmarApagarTodosBtn').addEventListener('click', () => {
    document.getElementById('confirmarApagarTodosModal').style.display = 'none';
    document.getElementById('confirmarApagarModal').style.display = 'block';
  });

  document.getElementById('cancelarApagarTodosBtn').addEventListener('click', () => {
    document.getElementById('confirmarApagarTodosModal').style.display = 'none';
  });

  document.addEventListener('DOMContentLoaded', toggleToupuMode);

  //Função mostrar usuarios conectados em tempo real
  const connectedUsersRef = firebase.database().ref('connectedUsers');
        const connectedRef = firebase.database().ref('.info/connected');

        connectedRef.on('value', (snap) => {
            if (snap.val() === true) {
                const con = connectedUsersRef.push();
                con.onDisconnect().remove();
                con.set(true);
            }
        });

        connectedUsersRef.on('value', (snap) => {
            const connectedUsers = snap.numChildren();
            document.getElementById('connectedUsersCount').textContent = connectedUsers;
        });
    

        const scrollToTopBtn = document.getElementById("scrollToTopBtn");

  window.addEventListener("scroll", () => {
    if (window.pageYOffset > 300) {
      scrollToTopBtn.classList.add("visible");
    } else {
      scrollToTopBtn.classList.remove("visible");
    }
  });

  scrollToTopBtn.addEventListener("click", () => {
    window.scrollTo({
      top: 0,
      behavior: "smooth"
    });
  });

  // Função para gerenciar a navegação entre os campos e enviar o formulário com a tecla enter
function handleEnterKey(event, mode) {
  // Verifica se a tecla pressionada é "Enter"
  if (event.key === "Enter") {
    event.preventDefault(); // Evita o comportamento padrão do Enter

    if (mode === "normal") {
      // Campos do modo normal
      const fields = [
        document.getElementById('codigoPeca'),
        document.getElementById('numeroLote'),
        document.getElementById('totalPecas'),
        document.getElementById('pecasPorCaixa'),
        document.getElementById('observacoes'),
        document.getElementById('calcular') // O botão de registrar
      ];

      // Encontra o índice do campo que disparou o evento
      const currentFieldIndex = fields.findIndex(field => field === document.activeElement);
      
      // Se o campo atual não for o último, move para o próximo
      if (currentFieldIndex < fields.length - 1) {
        fields[currentFieldIndex + 1].focus();
      } else {
        // Se for o último campo, clica no botão de registrar
        document.getElementById('calcular').click();
      }
    } else if (mode === "toupu") {
      // Campos do modo Toupu
      const fieldsToupu = [
        document.getElementById('codigoPecaToupu'),
        document.getElementById('numeroLoteToupu'),
        document.getElementById('totalPecasToupu'),
        document.getElementById('observacoesToupu'),
        document.getElementById('calcularToupu') // O botão de registrar
      ];

      // Encontra o índice do campo que disparou o evento
      const currentFieldIndexToupu = fieldsToupu.findIndex(field => field === document.activeElement);
      
      // Se o campo atual não for o último, move para o próximo
      if (currentFieldIndexToupu < fieldsToupu.length - 1) {
        fieldsToupu[currentFieldIndexToupu + 1].focus();
      } else {
        // Se for o último campo, clica no botão de registrar
        document.getElementById('calcularToupu').click();
      }
    }
  }
}

// Adiciona ouvintes de eventos para os campos de entrada do modo normal
document.querySelectorAll('.normal-inputs input').forEach(input => {
  input.addEventListener('keydown', (event) => handleEnterKey(event, "normal"));
});

// Adiciona ouvintes de eventos para os campos de entrada do modo Toupu
document.querySelectorAll('.toupu-inputs input, .toupu-inputs select').forEach(input => {
  input.addEventListener('keydown', (event) => handleEnterKey(event, "toupu"));
});

  function toggleToupuMode() {
  const isToupuMode = document.getElementById('toggleToupu').checked;

  // Controle dos botões de registro
  document.getElementById('calcular').style.display = isToupuMode ? 'none' : 'inline-block';
  document.getElementById('calcularToupu').style.display = isToupuMode ? 'inline-block' : 'none';

  // Controle da paginação
  document.getElementById('pagination').style.display = isToupuMode ? 'none' : 'flex';
  document.getElementById('paginationToupu').style.display = isToupuMode ? 'flex' : 'none';

  document.querySelector('.normal-inputs').style.display = isToupuMode ? 'none' : 'flex';
  document.querySelector('.toupu-inputs').style.display = isToupuMode ? 'flex' : 'none';
  document.getElementById('registrosTable').style.display = isToupuMode ? 'none' : 'table';
  document.getElementById('registrosToupuTable').style.display = isToupuMode ? 'table' : 'none';
  document.querySelector('.normal-search').style.display = isToupuMode ? 'none' : 'block';
  document.querySelector('.toupu-search').style.display = isToupuMode ? 'block' : 'none';

  // Limpar o conteúdo do elemento #calculosConteudo e #calculosToupuConteudo
  document.getElementById('calculosConteudo').innerHTML = '';
  document.getElementById('calculosToupuConteudo').innerHTML = '';

  // Atualiza a exibição dos cálculos detalhados com base no modo Toupu
  document.getElementById('mostrarCalculos').addEventListener('change', function() {
    if (isToupuMode) {
      document.getElementById('calculosDetalhados').style.display = 'none';
      document.getElementById('calculosToupuDetalhados').style.display = this.checked ? 'block' : 'none';
    } else {
      document.getElementById('calculosToupuDetalhados').style.display = 'none';
      document.getElementById('calculosDetalhados').style.display = this.checked ? 'block' : 'none';
    }
  });

  // Salvar registros no Firebase e atualizar a tabela quando o modo Toupu estiver desativado
  if (!isToupuMode) {
    registrosToupu.forEach(registro => {
      if (!registro.id) { // Gera o ID apenas para novos registros
        registro.id = `T${nextIdToupu}`;
        nextIdToupu++;
      }
      salvarRegistroToupuFirebase(registro); // Mantém os IDs existentes
    });

    atualizarTabelaToupu();
    salvarLocalStorageToupu();
  } else {
    carregarRegistrosToupuFirebase(); // Carrega os registros Toupu do Firebase
  }

  // Atualizar a tabela e os campos de entrada com base no modo ativo
  if (isToupuMode) {
    atualizarTabelaToupu();
    document.getElementById('codigoPecaToupu').focus();
  } else {
    atualizarTabela();
    document.getElementById('codigoPeca').focus();
  }
}


// Aguarda o carregamento do DOM antes de executar as funções
document.addEventListener('DOMContentLoaded', () => {
  // Carrega registros do Firebase e do Local Storage
  carregarRegistrosFirebase();
  carregarLocalStorage();
  carregarLocalStorageToupu();
  atualizarTabela();
  setupAutocomplete();
  loadSuggestionsFromFirebase();

  // Recupera o estado do switch do localStorage
   // Recupera o estado do switch do Modo Toupu do localStorage
   const isToupuMode = localStorage.getItem('isToupuMode') === 'true';
    document.getElementById('toggleToupu').checked = isToupuMode; // Define o estado do switch do modo Toupu
    atualizarExibicaoToupu(isToupuMode); // Atualiza a exibição com base no estado recuperado

    // Recupera o estado do switch de Mostrar Cálculos do localStorage
    const mostrarCalculos = localStorage.getItem('mostrarCalculos') === 'true';
    document.getElementById('mostrarCalculos').checked = mostrarCalculos; // Define o estado do switch de Mostrar Cálculos
      
  // Configura a exibição inicial com base no modo Toupu
  atualizarExibicaoToupu(isToupuMode);
});



</script>
</body>
</html> 
